var PropertiesReader=require("properties-reader"),fs=require("fs"),Promise=require("promise"),deferred=require("deferred"),lineReader=require("readline"),properties=new PropertiesReader("db.mapping.properties"),changelogChunk=null,buildFile=null,recompileFile=null,ddlKeyWords=[],config=null,invalidAfterFile=null,lineBuffer="",invalidBeforeFile=null,createFile=function(e,n,i){void 0===i&&(i=function(n){if(n)throw n;console.log("created '"+e+"' file...")}),fs.writeFile(e,n,i)},checkDirectory=function(e,n){fs.stat(e,function(i,o){i&&i.errno===-2?fs.mkdir(e,n):n(i)})},loadConfig=function(){var e=deferred();return config=JSON.parse(fs.readFileSync("config.json")),ddlKeyWords=config.ddlKeyWords,recompileFile=config.recompileFile,changelogChunk=config.changelogChunk,buildFile=config.buildFile,invalidAfterFile=config.invalidAfterFile,invalidBeforeFile=config.invalidBeforeFile,config.outputDir?checkDirectory(config.outputDir,function(n){if(n)throw n;buildFile=config.outputDir+config.buildFile,invalidAfterFile=config.outputDir+config.invalidAfterFile,invalidBeforeFile=config.outputDir+config.invalidBeforeFile,recompileFile=config.outputDir+config.recompileFile,e.resolve()}):e.resolve(),e.promise()},writeCallTestConnection=function(){var e=getListOfMappedUsers(),n="";fs.appendFile(buildFile,config.commentVarifyConn,function(e){if(e)throw e;console.log("write line test connection on db...")});for(var i=0;i<e.length;i++)n+=config.errorHandlerExit,n+=config.logPrefix+config.connectTestBefore.replace("#DB#",properties.get("db.user."+e[i])),n+=config.connectTest.replace("#DB#",properties.get("db.user."+e[i])),n+=config.logPrefix+config.connectTestAfter.replace("#DB#",properties.get("db.user."+e[i])),i!==e.length-1&&(n+=config.spaceChunk),lineBuffer+=n,n="";lineBuffer=lineBuffer+config.commentVarifyConnEnd+config.spaceChunk},writeInstallSpool=function(){return config.errorHandlerContinue.join("")+config.newLine+config.installLog+config.spaceChunk},writeSpooloff=function(e){var n=config.spoolOff+config.spaceChunk;return e&&fs.appendFile(e,n,function(e){if(e)throw e}),n},getTimeStamp=function(){var e,n=new Date;return e=[n.getDate(),".",n.getMonth()+1,".",n.getFullYear()," ",n.getHours(),":",n.getMinutes(),":",n.getSeconds()," "]},p=new Promise(function(e,n){var i,o;o=loadConfig(),o.done(function(){i=config.header.join(""),i=i.replace("#TIME#",getTimeStamp().join("")),createFile(buildFile,i+config.spaceChunk,function(n){if(n)throw n;console.log("created '"+buildFile+"' file..."),writeCallTestConnection(),e()})})}),checkIfApex=function(e){return"APEX"===e.toUpperCase()},writeCallRecompile=function(){var e,n=getListOfMappedUsers(),i="",o=config.outputDir?recompileFile.replace(config.outputDir,""):recompileFile;e=config.header.join(""),e=e.replace("#TIME#",getTimeStamp().join("")),createFile(recompileFile,e);for(var r=0;r<n.length;r++)0===r&&(i+=config.spaceChunk+config.recompileSpool+config.spaceChunk),checkIfApex(n[r])!==!0&&(i+=config.newLine+config.logPrefix+" "+config.logUserMsg.replace("#DB#",properties.get("db.user."+n[r]))+config.spaceChunk,i+=config.connectCommand.join("").replace("#DB#",properties.get("db.user."+n[r])),i+=config.errorHandlerContinue.join("")+config.spaceChunk,i+=config.recompileCommand.replace("#USER#",n[r].toUpperCase()),i+=config.spaceChunk,fs.appendFile(recompileFile,i,function(e){if(e)throw e;console.log("write line recompile objects list...")}),i="");writeSpooloff(recompileFile),lineBuffer=lineBuffer+config.logPrefix+" "+o+";"+config.newLine+config.includeChar+" "+o+";"+config.spaceChunk},writeLines=function(){fs.appendFile(buildFile,lineBuffer,function(e){if(e)throw e})},writeCallInvalid=function(e){var n,i=getListOfMappedUsers(),o="BEFORE"===e?config.InvalidBeforeSpool:config.InvalidAfterSpool,r="BEFORE"===e?invalidBeforeFile:invalidAfterFile,f="",c="";n=config.header.join(""),n=n.replace("#TIME#",getTimeStamp().join("")),createFile(r,n);for(var t=0;t<i.length;t++)0===t&&(f+=config.spaceChunk+o+config.spaceChunk),checkIfApex(i[t])!==!0&&(f+=config.newLine+config.logPrefix+" "+config.logUserMsg.replace("#DB#",properties.get("db.user."+i[t]))+config.spaceChunk,f+=config.connectCommand.join("").replace("#DB#",properties.get("db.user."+i[t])),f+=config.errorHandlerContinue.join("")+config.spaceChunk,f+=config.exportSQL,c+=f,f="");c+=writeSpooloff(),fs.appendFile(r,c,function(e){if(e)throw e;console.log("write line export invalid objects list...")}),config.outputDir&&(r=r.replace(config.outputDir,"")),lineBuffer=lineBuffer+config.logPrefix+" "+r+";"+config.newLine+config.includeChar+" "+r+";"+config.spaceChunk},getListOfMappedUsers=function(){var e=properties.getByRoot("db.user"),n=[];for(var i in e)n.push(i);return n},tryToSetConnection=function(e,n){for(var i="",o=!0,r=getListOfMappedUsers(),f=0;f<r.length;f++){if(e.toUpperCase().indexOf(r[f].toUpperCase()+".")>-1&&n!==r[f]){i+=config.connectCommand.join("").replace("#DB#",properties.get("db.user."+r[f])),i+=config.errorHandlerContinue.join("")+config.spaceChunk,n=r[f],""!==i&&(e="\n"+i+e,i=""),o=!1;break}if(e.toUpperCase().indexOf(r[f].toUpperCase()+".")>-1&&n===r[f]){o=!1;break}}return{line:e,noUserFound:o,lastConnectedUser:n}};p.then(function(){var e,n=null,i="",o=getListOfMappedUsers(),r=null,f=!0;n=lineReader.createInterface({input:fs.createReadStream(changelogChunk)}),writeCallInvalid("BEFORE"),lineBuffer+=writeInstallSpool(),n.on("line",function(n){if(n.startsWith("@")){n.toUpperCase().indexOf("APEX")>-1&&"apex"!==r&&(i+=config.connectCommand.join("").replace("#DB#",properties.get("db.user.apex")),i+=config.errorHandlerContinue.join("")+config.spaceChunk,r="apex",f=!1),"apex"===r&&(f=!1);for(var c=0;c<o.length;c++)(n.toUpperCase().indexOf(o[c].toUpperCase()+"/")>-1||n.toUpperCase().indexOf(o[c].toUpperCase()+"\\")>-1)&&r!==o[c]&&(i+=config.connectCommand.join("").replace("#DB#",properties.get("db.user."+o[c])),i+=config.errorHandlerContinue.join("")+config.spaceChunk,r=o[c],f=!1),(n.indexOf(o[c]+"/")>-1||n.toUpperCase().indexOf(o[c].toUpperCase()+"\\")>-1)&&r===o[c]&&(f=!1);f===!0&&(n=config.newLine+config.notifyBefore+config.newLine+n),n=config.newLine+config.logPrefix+" "+n.replace(config.includeChar,"").trim()+config.newLine+config.includeChar+" "+n.replace(config.includeChar,"").trim(),f===!0&&(n+=config.newLine+config.notifyAfter),""!==i&&(n=config.newLine+i+n,i=""),n+=config.newLine,n+="/",n+=config.spaceChunk}else if(n.toUpperCase().indexOf(config.PlSqlBlocks.join(" "))>-1)n=config.newLine+config.notifyBeforePLSQLBLocks+config.newLine+n;else if(n.toUpperCase().indexOf(config.ddlKeyWordsForceNotify.join(" "))>-1)e=tryToSetConnection(n,r),n=e.line,f=e.noUserFound,r=e.lastConnectedUser,n.indexOf(";")>-1&&(n+=config.newLine,n+="/",n+=config.newLine,n+=config.spaceChunk);else{for(var c=0;c<ddlKeyWords.length;c++)if(n.toUpperCase().indexOf(ddlKeyWords[c])>-1){n.indexOf(";")>-1&&(n=n.replace(config.newLine,""),n+=config.newLine,n+=config.newLine,n+=config.spaceChunk),e=tryToSetConnection(n,r),n=e.noUserFound===!0?config.newLine+config.notifyBefore+config.newLine+n:e.line,f=e.noUserFound,r=e.lastConnectedUser;break}n.indexOf(config.newLine)===-1&&(n+=config.newLine)}new RegExp(config.ddlKeyWordsForceNotify.join("|")).test(n.toUpperCase())===!0&&(n=config.newLine+config.notifyBefore+config.newLine+n+config.newLine+config.notifyAfter,n+=config.spaceChunk),lineBuffer+=n,f=!0}).on("close",function(){writeCallRecompile(),writeCallInvalid("AFTER"),writeLines(),fs.appendFile(buildFile,config.exit.join(""),function(e){if(e)throw e})})});